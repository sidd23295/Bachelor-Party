<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bachelor Party HQ</title>
  <style>
    :root{
      --bg:#07070a;
      --card: rgba(15,15,20,0.70);
      --panel: rgba(0,0,0,0.18);
      --border: rgba(255,255,255,0.10);
      --text:#f4f4f4;
      --muted:#bdbdbd;
      --neon1:#00f5ff;
      --neon2:#ff3df0;
      --neon3:#ffe66d;
      --good:#67ff7a;
      --bad:#ff5a5a;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1000px 650px at 10% 0%, rgba(0,245,255,0.16), transparent 60%),
        radial-gradient(1000px 650px at 90% 10%, rgba(255,61,240,0.14), transparent 60%),
        radial-gradient(900px 600px at 50% 110%, rgba(255,230,109,0.10), transparent 55%),
        linear-gradient(180deg, #06060a, #0a0a10);
      overflow-x:hidden;
    }
    .wrap{padding:22px; display:grid; place-items:center;}
    .shell{
      width:min(1180px, 96vw);
      border-radius:22px;
      background: rgba(10,10,14,0.45);
      border:1px solid var(--border);
      box-shadow:0 20px 70px rgba(0,0,0,0.65);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    header{
      padding:18px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      flex-wrap:wrap;
    }
    .title{
      font-size:22px;
      font-weight:950;
      letter-spacing:.02em;
      text-shadow: 0 0 14px rgba(0,245,255,0.16), 0 0 28px rgba(255,61,240,0.10);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.04);
      white-space:nowrap;
    }
    .btn{
      appearance:none;
      border:none;
      color:var(--text);
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.14);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      transition: transform .06s ease, background .15s ease;
    }
    .btn:hover{background:rgba(255,255,255,0.12);}
    .btn:active{transform:scale(0.98);}
    .btn.primary{
      border-color: rgba(0,245,255,0.45);
      box-shadow: 0 0 0 3px rgba(0,245,255,0.10);
    }
    .btn.danger{
      border-color: rgba(255,90,90,0.35);
      box-shadow: 0 0 0 3px rgba(255,90,90,0.08);
    }

    .topControls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:14px;
      padding:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.10);
      background:var(--panel);
      overflow:hidden;
    }
    .card .h{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .card .h h2{
      margin:0;
      font-size:14px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:900;
    }
    .card .b{padding:14px;}
    .muted{color:#d2d2d2; line-height:1.55;}
    .small{color:var(--muted); font-size:12px; line-height:1.5;}
    code{background:rgba(255,255,255,0.08); padding:2px 6px; border-radius:8px;}

    /* Phase buttons */
    .phaseRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .phaseBtn{
      font-weight:900;
      border-radius:999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.04);
      cursor:pointer;
      color:#eaeaea;
      transition: background .15s ease, transform .06s ease;
    }
    .phaseBtn:hover{background:rgba(255,255,255,0.08);}
    .phaseBtn:active{transform:scale(0.98);}
    .phaseBtn.active{
      border-color: rgba(0,245,255,0.45);
      box-shadow: 0 0 0 3px rgba(0,245,255,0.10);
      background: rgba(0,245,255,0.08);
    }

    /* Timeline */
    .timeline{
      display:grid;
      gap:10px;
    }
    .event{
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      padding:12px;
      display:grid;
      gap:6px;
    }
    .eventTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .eventTitle{
      display:flex;
      gap:10px;
      align-items:center;
      font-weight:950;
    }
    .tag{
      font-size:11px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.04);
      color:var(--muted);
      letter-spacing:.10em;
      text-transform:uppercase;
    }
    .event.active{
      border-color: rgba(255,61,240,0.35);
      box-shadow: 0 0 0 3px rgba(255,61,240,0.10);
      background: rgba(255,61,240,0.06);
    }
    .eventInputs{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px;
    }
    @media (max-width: 560px){
      .eventInputs{grid-template-columns:1fr;}
    }
    .field{
      display:grid;
      gap:6px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:800;
    }
    input, textarea{
      width:100%;
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:12px;
      padding:10px 10px;
      color:var(--text);
      outline:none;
      font-weight:700;
    }
    textarea{min-height:72px; resize:vertical; font-weight:650;}
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,0.35); font-weight:650;}
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
      align-items:center;
    }
    .chip{
      padding:9px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.04);
      color:#e8e8e8;
      font-size:13px;
      text-decoration:none;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip:hover{background:rgba(255,255,255,0.08);}

    /* Checklist */
    .checklist{
      display:grid;
      gap:10px;
    }
    .check{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
    }
    .check input{width:auto; margin-top:3px;}
    .check b{font-weight:950;}
    .check small{display:block; color:var(--muted); margin-top:2px; line-height:1.35;}

    /* Scoreboard */
    .scoreGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){ .scoreGrid{grid-template-columns:1fr;} }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(0,0,0,0.55);
      color:#f1f1f1;
      display:none;
      z-index:50;
      max-width: min(92%, 520px);
      text-align:center;
    }
    .toast.show{display:block; animation: toastIn .22s ease-out;}
    @keyframes toastIn{from{opacity:0; transform:translateX(-50%) translateY(6px);} to{opacity:1; transform:translateX(-50%) translateY(0);} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <header>
        <div class="title">üòà Bachelor Party HQ <span class="pill">Interactive</span></div>
        <div class="topControls">
          <button class="btn" id="saveBtn">Save</button>
          <button class="btn" id="resetDataBtn">Reset Page Data</button>
          <button class="btn danger" id="lockBtn" title="Clears unlock + sends you back to the gate">Lock Again</button>
          <a class="btn primary" href="./index.html">Back to Gate</a>
        </div>
      </header>

      <div class="grid">
        <!-- LEFT COLUMN -->
        <section class="card" id="planCard">
          <div class="h">
            <h2>Game Plan</h2>
            <div class="phaseRow" id="phaseRow"></div>
          </div>
          <div class="b">
            <p class="muted">
              Select the current phase to highlight what‚Äôs happening now. Edit times/locations/links and hit <b>Save</b>.
            </p>
            <div class="timeline" id="timeline"></div>

            <div class="row" style="margin-top:14px;">
              <a class="chip" href="#" id="openDiner">üç≥ Diner Maps</a>
              <a class="chip" href="#" id="openRPM">üèéÔ∏è RPM Maps</a>
              <a class="chip" href="#" id="openCrawl">üçª Bar Crawl Route</a>
              <a class="chip" href="#" id="openGame">üéÆ Gaming Cafe</a>
            </div>

            <p class="small" style="margin-top:12px;">
              Tip: paste full Google Maps URLs into the link fields. If a link is empty, the button won‚Äôt do anything.
            </p>
          </div>
        </section>

        <!-- RIGHT COLUMN -->
        <section class="card">
          <div class="h">
            <h2>Side Quests</h2>
            <span class="pill">Checklist</span>
          </div>
          <div class="b">
            <div class="checklist" id="checklist"></div>
            <div class="row">
              <button class="btn" id="addQuestBtn">Add Quest</button>
              <button class="btn" id="randomChallengeBtn">Random Challenge</button>
            </div>
            <div class="small" id="challengeBox" style="margin-top:10px;"></div>
          </div>
        </section>

        <section class="card">
          <div class="h">
            <h2>Scoreboard</h2>
            <span class="pill">Saved locally</span>
          </div>
          <div class="b">
            <div class="scoreGrid">
              <div class="field">
                <label>Fastest Lap</label>
                <input id="fastestLap" placeholder="e.g., 42.18s (Name)" />
              </div>
              <div class="field">
                <label>Kart Winner</label>
                <input id="kartWinner" placeholder="e.g., Name" />
              </div>
              <div class="field">
                <label>CS2 / Game Result</label>
                <input id="gameResult" placeholder="e.g., Team A 13‚Äì9 Team B" />
              </div>
              <div class="field">
                <label>MVP</label>
                <input id="mvp" placeholder="e.g., Name" />
              </div>
            </div>
            <div class="field" style="margin-top:10px;">
              <label>Notes</label>
              <textarea id="notes" placeholder="Any rules, reminders, or ‚Äúdon‚Äôt forget‚Äù info..."></textarea>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="h">
            <h2>Emergency Plan</h2>
            <span class="pill">Actually useful</span>
          </div>
          <div class="b">
            <div class="field">
              <label>Home Base Address</label>
              <input id="homeBase" placeholder="Hotel/Airbnb address" />
            </div>
            <div class="scoreGrid" style="margin-top:10px;">
              <div class="field">
                <label>Designated Contact</label>
                <input id="contact" placeholder="Name + phone" />
              </div>
              <div class="field">
                <label>Meetup Point</label>
                <input id="meetupPoint" placeholder="If lost, go here" />
              </div>
            </div>
            <div class="small" style="margin-top:10px;">
              If someone gets split: go to meetup point ‚Üí call designated contact ‚Üí regroup.
            </div>
          </div>
        </section>
      </div>

      <footer style="padding:14px 14px 16px; color:var(--muted); border-top:1px solid rgba(255,255,255,0.08); display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div>Edit details once, hit <b>Save</b>, and it stays on your device.</div>
        <div>üéâ Legendary *and* safe.</div>
      </footer>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---- Keys ----
    const UNLOCK_KEY = "bp_unlocked_v1";
    const DATA_KEY = "bp_party_data_v1";

    // ---- Defaults (your planned activities) ----
    const defaultData = {
      phase: "pregame",
      events: [
        {
          id: "breakfast",
          phase: "pregame",
          emoji: "üç≥",
          title: "Breakfast ‚Äì Diner",
          time: "9:30 AM",
          location: "",
          link: "",
          notes: "Eat breakfast, coffee, and set the vibe."
        },
        {
          id: "rpm",
          phase: "rpm",
          emoji: "üèéÔ∏è",
          title: "RPM Raceway",
          time: "11:00 AM",
          location: "",
          link: "",
          notes: "Driving simulators ‚Üí go-karts ‚Üí crown fastest lap."
        },
        {
          id: "crawl",
          phase: "crawl",
          emoji: "üçª",
          title: "Bar Crawl + Vegan Dinner",
          time: "3:00 PM",
          location: "",
          link: "",
          notes: "Start drinking ‚Üí vegan dinner reset ‚Üí keep it moving."
        },
        {
          id: "gaming",
          phase: "gaming",
          emoji: "üéÆ",
          title: "Gaming Cafe (5v5)",
          time: "8:00 PM",
          location: "",
          link: "",
          notes: "CS2 (or alternate). MVP gets bragging rights."
        }
      ],
      quickLinks: {
        diner: "",
        rpm: "",
        crawl: "",
        gaming: ""
      },
      quests: [
        { id: "q1", text: "Breakfast: everyone orders one wildcard item.", done: false },
        { id: "q2", text: "RPM: screenshot fastest lap. Winner gets crowned.", done: false },
        { id: "q3", text: "Bar crawl: 10-minute no-phone round at one stop.", done: false },
        { id: "q4", text: "Vegan dinner: pick a shared appetizer for the table.", done: false },
        { id: "q5", text: "Gaming: MVP names the team. Losers do pushups (or buy dessert).", done: false }
      ],
      scoreboard: {
        fastestLap: "",
        kartWinner: "",
        gameResult: "",
        mvp: "",
        notes: ""
      },
      emergency: {
        homeBase: "",
        contact: "",
        meetupPoint: ""
      }
    };

    // ---- Challenges ----
    const randomChallenges = [
      "At the next bar: everyone orders for the person to their right (one drink).",
      "Silent round: 5 minutes, no speaking. Communicate only with gestures.",
      "Photo quest: get a group photo with a stranger taking it (no selfies).",
      "Vegan dinner: pick one dish none of you have tried before.",
      "Gaming: loser team plays one round with inverted roles (AWP-only / pistols-only).",
      "RPM: whoever is last picks the next stop (within reason).",
      "Bar crawl: one person must give a 30-second toast‚Äîno notes.",
      "Gaming: MVP must 1v1 the bachelor (or the loudest friend) to defend the title."
    ];

    // ---- State ----
    let state = loadState();

    // ---- Helpers ----
    function loadState(){
      try{
        const raw = localStorage.getItem(DATA_KEY);
        if(!raw) return structuredClone(defaultData);
        const parsed = JSON.parse(raw);

        // merge in any new default fields safely
        return {
          ...structuredClone(defaultData),
          ...parsed,
          quickLinks: { ...structuredClone(defaultData.quickLinks), ...(parsed.quickLinks || {}) },
          scoreboard: { ...structuredClone(defaultData.scoreboard), ...(parsed.scoreboard || {}) },
          emergency: { ...structuredClone(defaultData.emergency), ...(parsed.emergency || {}) },
          events: Array.isArray(parsed.events) && parsed.events.length ? parsed.events : structuredClone(defaultData.events),
          quests: Array.isArray(parsed.quests) && parsed.quests.length ? parsed.quests : structuredClone(defaultData.quests),
        };
      } catch {
        return structuredClone(defaultData);
      }
    }

    function saveState(){
      localStorage.setItem(DATA_KEY, JSON.stringify(state));
      toast("Saved ‚úÖ", true);
      render();
    }

    function toast(msg, good=true){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.style.borderColor = good ? "rgba(103,255,122,0.35)" : "rgba(255,90,90,0.35)";
      el.style.boxShadow = good ? "0 0 0 3px rgba(103,255,122,0.10)" : "0 0 0 3px rgba(255,90,90,0.10)";
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.classList.remove("show"), 900);
    }

    function id(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function safeOpen(url){
      if(!url || !url.trim()){
        toast("No link set yet.", false);
        return;
      }
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // ---- Renderers ----
    const phases = [
      { key:"pregame", label:"Pre-game", emoji:"üç≥" },
      { key:"rpm", label:"RPM", emoji:"üèéÔ∏è" },
      { key:"crawl", label:"Bar Crawl", emoji:"üçª" },
      { key:"gaming", label:"Gaming", emoji:"üéÆ" }
    ];

    function renderPhaseButtons(){
      const row = document.getElementById("phaseRow");
      row.innerHTML = "";
      phases.forEach(p => {
        const btn = document.createElement("button");
        btn.className = "phaseBtn" + (state.phase === p.key ? " active" : "");
        btn.textContent = `${p.emoji} ${p.label}`;
        btn.onclick = () => { state.phase = p.key; saveState(); };
        row.appendChild(btn);
      });
    }

    function renderTimeline(){
      const el = document.getElementById("timeline");
      el.innerHTML = "";

      state.events.forEach((ev, idx) => {
        const card = document.createElement("div");
        card.className = "event" + (ev.phase === state.phase ? " active" : "");

        const top = document.createElement("div");
        top.className = "eventTop";

        const left = document.createElement("div");
        left.className = "eventTitle";
        left.innerHTML = `<span style="font-size:18px">${ev.emoji || "‚ú®"}</span><span>${ev.title}</span>`;

        const tag = document.createElement("span");
        tag.className = "tag";
        const phaseObj = phases.find(p => p.key === ev.phase);
        tag.textContent = (phaseObj ? phaseObj.label : "Phase");

        top.appendChild(left);
        top.appendChild(tag);

        const inputs = document.createElement("div");
        inputs.className = "eventInputs";

        inputs.innerHTML = `
          <div class="field">
            <label>Time</label>
            <input data-k="time" value="${escapeAttr(ev.time || "")}" placeholder="e.g., 11:00 AM" />
          </div>
          <div class="field">
            <label>Location</label>
            <input data-k="location" value="${escapeAttr(ev.location || "")}" placeholder="Name / address" />
          </div>
          <div class="field" style="grid-column: 1 / -1;">
            <label>Link (Maps / Website)</label>
            <input data-k="link" value="${escapeAttr(ev.link || "")}" placeholder="https://..." />
          </div>
          <div class="field" style="grid-column: 1 / -1;">
            <label>Notes</label>
            <textarea data-k="notes" placeholder="Details...">${escapeHtml(ev.notes || "")}</textarea>
          </div>
        `;

        // wire input changes
        inputs.querySelectorAll("input,textarea").forEach(inp => {
          inp.addEventListener("input", (e) => {
            const k = e.target.getAttribute("data-k");
            state.events[idx][k] = e.target.value;
          });
        });

        const actions = document.createElement("div");
        actions.className = "row";
        actions.innerHTML = `
          <a class="chip" href="#" data-act="open">üîó Open Link</a>
          <button class="btn" data-act="up">Move Up</button>
          <button class="btn" data-act="down">Move Down</button>
        `;

        actions.querySelector('[data-act="open"]').onclick = (e) => {
          e.preventDefault();
          safeOpen(state.events[idx].link);
        };

        actions.querySelector('[data-act="up"]').onclick = () => {
          if(idx === 0) return;
          const tmp = state.events[idx-1];
          state.events[idx-1] = state.events[idx];
          state.events[idx] = tmp;
          saveState();
        };
        actions.querySelector('[data-act="down"]').onclick = () => {
          if(idx === state.events.length - 1) return;
          const tmp = state.events[idx+1];
          state.events[idx+1] = state.events[idx];
          state.events[idx] = tmp;
          saveState();
        };

        card.appendChild(top);
        card.appendChild(inputs);
        card.appendChild(actions);
        el.appendChild(card);
      });
    }

    function renderChecklist(){
      const el = document.getElementById("checklist");
      el.innerHTML = "";

      state.quests.forEach((q, idx) => {
        const row = document.createElement("div");
        row.className = "check";
        row.innerHTML = `
          <input type="checkbox" ${q.done ? "checked" : ""} />
          <div style="flex:1;">
            <b>${escapeHtml(q.text)}</b>
            <small>${q.done ? "Completed. Respect." : "Unfinished business."}</small>
          </div>
          <button class="btn" title="Remove">‚úï</button>
        `;

        const cb = row.querySelector("input");
        cb.onchange = () => {
          state.quests[idx].done = cb.checked;
          saveState();
        };

        const del = row.querySelector("button");
        del.onclick = () => {
          state.quests.splice(idx, 1);
          saveState();
        };

        el.appendChild(row);
      });
    }

    function renderScoreboard(){
      setVal("fastestLap", state.scoreboard.fastestLap);
      setVal("kartWinner", state.scoreboard.kartWinner);
      setVal("gameResult", state.scoreboard.gameResult);
      setVal("mvp", state.scoreboard.mvp);
      setVal("notes", state.scoreboard.notes);

      setVal("homeBase", state.emergency.homeBase);
      setVal("contact", state.emergency.contact);
      setVal("meetupPoint", state.emergency.meetupPoint);
    }

    function renderQuickLinks(){
      // If you want separate quick links: we just map to the same event links by default
      const diner = state.events.find(e => e.id === "breakfast")?.link || state.quickLinks.diner;
      const rpm = state.events.find(e => e.id === "rpm")?.link || state.quickLinks.rpm;
      const crawl = state.events.find(e => e.id === "crawl")?.link || state.quickLinks.crawl;
      const gaming = state.events.find(e => e.id === "gaming")?.link || state.quickLinks.gaming;

      document.getElementById("openDiner").onclick = (e) => { e.preventDefault(); safeOpen(diner); };
      document.getElementById("openRPM").onclick = (e) => { e.preventDefault(); safeOpen(rpm); };
      document.getElementById("openCrawl").onclick = (e) => { e.preventDefault(); safeOpen(crawl); };
      document.getElementById("openGame").onclick = (e) => { e.preventDefault(); safeOpen(gaming); };
    }

    function render(){
      renderPhaseButtons();
      renderTimeline();
      renderChecklist();
      renderScoreboard();
      renderQuickLinks();
    }

    // ---- Wiring inputs -> state ----
    function wireInputs(){
      // scoreboard
      onInput("fastestLap", v => state.scoreboard.fastestLap = v);
      onInput("kartWinner", v => state.scoreboard.kartWinner = v);
      onInput("gameResult", v => state.scoreboard.gameResult = v);
      onInput("mvp", v => state.scoreboard.mvp = v);
      onInput("notes", v => state.scoreboard.notes = v);

      // emergency
      onInput("homeBase", v => state.emergency.homeBase = v);
      onInput("contact", v => state.emergency.contact = v);
      onInput("meetupPoint", v => state.emergency.meetupPoint = v);

      // buttons
      document.getElementById("saveBtn").onclick = saveState;

      document.getElementById("resetDataBtn").onclick = () => {
        if(!confirm("Reset itinerary, quests, scoreboard, and emergency info on this device?")) return;
        state = structuredClone(defaultData);
        saveState();
      };

      document.getElementById("lockBtn").onclick = () => {
        localStorage.removeItem(UNLOCK_KEY);
        window.location.href = "./index.html";
      };

      document.getElementById("addQuestBtn").onclick = () => {
        const text = prompt("Add a side quest (short text):");
        if(!text || !text.trim()) return;
        state.quests.unshift({ id: id(), text: text.trim(), done: false });
        saveState();
      };

      document.getElementById("randomChallengeBtn").onclick = () => {
        const pick = randomChallenges[Math.floor(Math.random() * randomChallenges.length)];
        const box = document.getElementById("challengeBox");
        box.innerHTML = `<span class="pill" style="border-color: rgba(255,61,240,0.35); color:#ddd;">Challenge</span> &nbsp; ${escapeHtml(pick)}`;
      };
    }

    function onInput(id, fn){
      const el = document.getElementById(id);
      el.addEventListener("input", () => fn(el.value));
      el.addEventListener("change", () => fn(el.value));
    }
    function setVal(id, v){
      const el = document.getElementById(id);
      if(el && el.value !== v) el.value = v || "";
    }

    // ---- Escape helpers ----
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

    // ---- Init ----
    wireInputs();
    render();
  </script>
</body>
</html>
